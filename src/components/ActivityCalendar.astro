---
// ECharts æ´»åŠ¨æ—¥å†çƒ­åŠ›å›¾ç»„ä»¶
export interface Props {
  posts?: any[];
}

const { posts = [] } = Astro.props;

function generateActivityData(posts: any[]) {
  const data: [string, number][] = [];
  const dateCountMap: { [key: string]: number } = {};
  
  // ç”Ÿæˆè¿‡å»ä¸€å¹´çš„æ—¥æœŸèŒƒå›´
  const today = new Date();
  const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
  
  // åˆå§‹åŒ–æ‰€æœ‰æ—¥æœŸä¸º0
  for (let d = new Date(oneYearAgo); d <= today; d.setDate(d.getDate() + 1)) {
    const dateStr = d.toISOString().split('T')[0];
    dateCountMap[dateStr] = 0;
  }
  
  // æ ¹æ®æ–‡ç« å‘å¸ƒæ—¥æœŸå¢åŠ æ´»åŠ¨
  posts.forEach(post => {
    if (post.frontmatter?.pubDate) {
      const pubDate = new Date(post.frontmatter.pubDate);
      const dateStr = pubDate.toISOString().split('T')[0];
      if (dateCountMap.hasOwnProperty(dateStr)) {
        dateCountMap[dateStr] += 3; // å‘å¸ƒæ–‡ç« ç®—3æ¬¡æ´»åŠ¨
      }
    }
  });
  
  // æ·»åŠ ä¸€äº›éšæœºæ´»åŠ¨æ¥æ¨¡æ‹Ÿç¼–ç æ´»åŠ¨
  Object.keys(dateCountMap).forEach(date => {
    if (Math.random() > 0.7) {
      dateCountMap[date] += Math.floor(Math.random() * 5) + 1;
    }
  });
  
  // è½¬æ¢ä¸ºEChartséœ€è¦çš„æ ¼å¼
  Object.entries(dateCountMap).forEach(([date, count]) => {
    data.push([date, count]);
  });
  
  return data;
}

const activityData = generateActivityData(posts);
const totalContributions = activityData.reduce((sum, [_, count]) => sum + count, 0);
---

<section class="activity-calendar">
  <div class="calendar-container">
    <div class="calendar-header">
      <h3>ğŸ“Š æ´»åŠ¨çƒ­åŠ›å›¾</h3>
      <p>è¿‡å»ä¸€å¹´å…±æœ‰ <strong>{totalContributions}</strong> æ¬¡æ´»åŠ¨</p>
    </div>
    
    <!-- ECharts å®¹å™¨ -->
    <div id="activity-chart" class="chart-container"></div>
    
    <div class="calendar-legend">
      <span>MIN</span>
      <div class="legend-squares">
        <div class="legend-square level-0"></div>
        <div class="legend-square level-1"></div>
        <div class="legend-square level-2"></div>
        <div class="legend-square level-3"></div>
        <div class="legend-square level-4"></div>
      </div>
      <span>MAX</span>
    </div>
  </div>
</section>

<script>
  import * as echarts from 'echarts';

  // æ¥æ”¶æœåŠ¡ç«¯ç”Ÿæˆçš„æ•°æ®
  const chartData = JSON.parse(document.getElementById('chart-data-hidden').textContent);

  const initChart = () => {
    const chartDom = document.getElementById('activity-chart');
    if (!chartDom) return;

    const myChart = echarts.init(chartDom, null, { renderer: 'canvas' });
    
    // ç”Ÿæˆè¿‡å»ä¸€å¹´çš„æ—¥æœŸ
    const today = new Date();
    const range = [
      new Date(today.getFullYear() - 1, today.getMonth(), today.getDate()).toISOString().split('T')[0],
      today.toISOString().split('T')[0]
    ];

    const option = {
      tooltip: {
        position: 'top',
        formatter: function (p: any) {
          const format = echarts.format.formatTime('yyyy-MM-dd', p.data[0]);
          return format + ': ' + p.data[1] + ' activities';
        },
        backgroundColor: 'rgba(255, 255, 255, 0.9)',
        borderColor: '#06B6D4',
        textStyle: {
          color: '#1E3A8A'
        }
      },
      visualMap: {
        min: 0,
        max: 10,
        calculable: false,
        orient: 'horizontal',
        left: 'center',
        bottom: 0,
        show: false, // ä½¿ç”¨è‡ªå®šä¹‰å›¾ä¾‹
        inRange: {
          color: ['#E0F2FE', '#BAE6FD', '#7DD3FC', '#38BDF8', '#0EA5E9']
        }
      },
      calendar: {
        top: 30,
        left: 30,
        right: 30,
        cellSize: ['auto', 13],
        range: range,
        itemStyle: {
          borderWidth: 2,
          borderColor: 'transparent', // é€æ˜è¾¹æ¡†
          color: 'rgba(255, 255, 255, 0.1)' // ç©ºå•å…ƒæ ¼é¢œè‰²
        },
        yearLabel: { show: false },
        dayLabel: {
          firstDay: 1,
          nameMap: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
          color: '#9CA3AF'
        },
        monthLabel: {
          color: '#9CA3AF'
        },
        splitLine: {
          show: false
        }
      },
      series: {
        type: 'heatmap',
        coordinateSystem: 'calendar',
        data: chartData,
        itemStyle: {
          borderRadius: 2
        }
      }
    };

    myChart.setOption(option);

    window.addEventListener('resize', () => {
      myChart.resize();
    });
  };

  // ç¡®ä¿åœ¨é¡µé¢åŠ è½½åè¿è¡Œ
  document.addEventListener('astro:page-load', initChart);
  document.addEventListener('DOMContentLoaded', initChart);
</script>

<script type="application/json" id="chart-data-hidden">
  {JSON.stringify(activityData)}
</script>

<style>
  .activity-calendar {
    /* èƒŒæ™¯æ ·å¼ç”±çˆ¶å®¹å™¨ glass-card æ§åˆ¶ï¼Œè¿™é‡Œåªéœ€å¤„ç†å†…éƒ¨å¸ƒå±€ */
    padding: 0; 
  }

  .calendar-container {
    width: 100%;
  }

  .calendar-header {
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    border-bottom: 1px dashed var(--color-neutral-light);
    padding-bottom: 1rem;
  }

  .calendar-header h3 {
    margin: 0;
    font-size: 1.2rem;
    color: var(--color-text-title);
    font-family: var(--font-mono);
    letter-spacing: 0.05em;
  }

  .calendar-header p {
    color: var(--color-neutral);
    margin: 0;
    font-size: 0.9rem;
    font-family: var(--font-mono);
  }
  
  .calendar-header strong {
    color: var(--color-primary-start);
  }

  .chart-container {
    width: 100%;
    height: 180px; /* è°ƒæ•´é«˜åº¦ */
  }

  .calendar-legend {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: var(--color-neutral);
    margin-top: -10px;
    font-family: var(--font-mono);
  }

  .legend-squares {
    display: flex;
    gap: 3px;
  }

  .legend-square {
    width: 10px;
    height: 10px;
    border-radius: 2px;
  }

  .level-0 { background-color: #E0F2FE; opacity: 0.3; }
  .level-1 { background-color: #BAE6FD; }
  .level-2 { background-color: #7DD3FC; }
  .level-3 { background-color: #38BDF8; }
  .level-4 { background-color: #0EA5E9; }


  .calendar-legend {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: #718096;
  }

  .legend-squares {
    display: flex;
    gap: 2px;
  }

  .legend-square {
    width: 10px;
    height: 10px;
    border-radius: 2px;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .activity-calendar {
      padding: 1rem;
      margin: 1rem 0;
    }

    .chart-container {
      height: 160px;
    }
  }
</style>

<script define:vars={{ activityData }}>
  // å¼‚æ­¥åŠ è½½ECharts
  let echarts;
  
  async function loadECharts() {
    if (typeof window !== 'undefined') {
      echarts = await import('echarts');
      initChart();
    }
  }
  
  function initChart() {
    const chartDom = document.getElementById('activity-chart');
    if (!chartDom || !echarts) {
      console.error('ActivityCalendar: æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨æˆ–EChartsæœªåŠ è½½');
      return;
    }
    
    const myChart = echarts.init(chartDom);
    
    console.log('ActivityCalendar: ECharts åˆå§‹åŒ–æˆåŠŸ');
    console.log('ActivityCalendar: æ•°æ®é¡¹æ•°:', activityData.length);
    
    if (activityData.length > 0) {
      console.log('ActivityCalendar: ç¬¬ä¸€é¡¹æ•°æ®:', activityData[0]);
      console.log('ActivityCalendar: æœ€åä¸€é¡¹æ•°æ®:', activityData[activityData.length - 1]);
    }
    
    // è®¡ç®—æ—¥æœŸèŒƒå›´
    const today = new Date();
    const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
    
    const option = {
      tooltip: {
        formatter: function(params) {
          const date = new Date(params.data[0]).toLocaleDateString('zh-CN');
          const count = params.data[1];
          return `${date}<br/>æ´»åŠ¨æ¬¡æ•°: ${count}`;
        }
      },
      visualMap: {
        min: 0,
        max: 15,
        type: 'piecewise',
        orient: 'horizontal',
        left: 'center',
        bottom: 10,
        pieces: [
          {min: 0, max: 0, color: '#ebedf0'},
          {min: 1, max: 3, color: '#9be9a8'},
          {min: 4, max: 6, color: '#40c463'},
          {min: 7, max: 10, color: '#30a14e'},
          {min: 11, max: 15, color: '#216e39'}
        ],
        text: ['å¤š', 'å°‘'],
        textStyle: {
          color: '#718096',
          fontSize: 12
        }
      },
      calendar: {
        top: 30,
        left: 30,
        right: 30,
        bottom: 60,
        cellSize: ['auto', 13],
        range: [oneYearAgo.toISOString().split('T')[0], today.toISOString().split('T')[0]],
        itemStyle: {
          borderWidth: 0.5,
          borderColor: '#e2e8f0'
        },
        yearLabel: {
          show: false
        },
        monthLabel: {
          nameMap: 'cn',
          fontSize: 12,
          color: '#718096'
        },
        dayLabel: {
          nameMap: 'cn',
          fontSize: 10,
          color: '#718096'
        }
      },
      series: {
        type: 'heatmap',
        coordinateSystem: 'calendar',
        data: activityData
      }
    };
    
    myChart.setOption(option);
    
    // å“åº”å¼å¤„ç†
    window.addEventListener('resize', function() {
      myChart.resize();
    });
    
    console.log('ActivityCalendar: å›¾è¡¨é…ç½®å®Œæˆ');
  }
  
  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    loadECharts();
  });
</script>